<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🌍 Smart Carbon Journey Planner</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Leaflet CSS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <!-- Custom CSS for Styling -->
    <style>
        body {
            background-color: #f4f7f6;
        }
        .navbar-dark {
            background-color: #2c3e50 !important;
        }
        .card-gradient {
            color: white;
            border: none;
            border-radius: 10px;
        }
        .eco-card { background: linear-gradient(135deg, #28a745, #20c997); }
        .warning-card { background: linear-gradient(135deg, #ffc107, #fd7e14); }
        .info-card { background: linear-gradient(135deg, #17a2b8, #007bff); }
        .danger-card { background: linear-gradient(135deg, #dc3545, #e74c3c); }
        .carbon-score { font-size: 2.5em; font-weight: bold; text-align: center; }
        .savings-highlight { background-color: #d4edda; border: 1px solid #c3e6cb; border-radius: 5px; padding: 15px; margin: 10px 0; }
        .metric-box {
            background-color: #ffffff;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin: 10px 0;
            text-align: center;
            height: 100%;
        }
        .metric-value { font-size: 2em; font-weight: bold; color: #007bff; }
        .btn-custom {
            background: linear-gradient(135deg, #007bff, #0056b3);
            border: none;
            color: white;
            font-weight: bold;
        }
        .btn-custom:hover {
            color: white;
            opacity: 0.9;
        }
        #advanced_map {
            height: 400px;
            border-radius: 8px;
        }
        /* Make form-check labels more readable */
        .form-check-label {
             padding-left: 0.5em;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <header class="text-center mb-4">
            <h1>🌍 Smart Carbon Journey Planner</h1>
            <p class="lead">Make informed, eco-friendly travel decisions.</p>
        </header>

        <ul class="nav nav-tabs nav-fill mb-3" id="mainTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="planner-tab" data-bs-toggle="tab" data-bs-target="#planner" type="button" role="tab">🚗 Journey Planner</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">📊 Dashboard</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="offset-tab" data-bs-toggle="tab" data-bs-target="#offset" type="button" role="tab">🌱 Carbon Offset</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="challenges-tab" data-bs-toggle="tab" data-bs-target="#challenges" type="button" role="tab">🏆 Eco Challenges</button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabContent">
            <!-- Journey Planner Tab -->
            <div class="tab-pane fade show active" id="planner" role="tabpanel">
                <div class="row">
                    <div class="col-lg-4">
                        <div class="card shadow-sm mb-4">
                            <div class="card-body">
                                <h3 class="card-title">📍 Journey Details</h3>
                                <form id="journeyForm">
                                    <div class="mb-3">
                                        <label for="from" class="form-label">From:</label>
                                        <input type="text" id="from" class="form-control" placeholder="Bratislava, London, New York..." value="Bratislava">
                                    </div>
                                    <div class="mb-3">
                                        <label for="to" class="form-label">To:</label>
                                        <input type="text" id="to" class="form-control" placeholder="Prague, Paris, Tokyo..." value="Prague">
                                        <div class="form-text">💡 Try: Bratislava, Prague, Vienna, London, Paris...</div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6 mb-3">
                                            <label for="travel_date" class="form-label">Travel Date:</label>
                                            <input type="date" id="travel_date" class="form-control">
                                        </div>
                                        <div class="col-6 mb-3">
                                            <label for="passengers" class="form-label">Passengers: <span id="passengers-label">1</span></label>
                                            <input type="range" id="passengers" class="form-range" min="1" max="8" value="1">
                                        </div>
                                    </div>
                                    <div class="form-check form-switch mb-3">
                                        <input class="form-check-input" type="checkbox" role="switch" id="return_trip">
                                        <label class="form-check-label" for="return_trip">Round Trip</label>
                                    </div>

                                    <h4 class="mt-4">🚊 Transport Options</h4>
                                    <div id="transport_types" class="mb-3">
                                        <div class="form-check"><input class="form-check-input" type="checkbox" value="car_petrol" id="tp1" checked><label class="form-check-label" for="tp1">🚗 Car (Petrol)</label></div>
                                        <div class="form-check"><input class="form-check-input" type="checkbox" value="car_diesel" id="tp2"><label class="form-check-label" for="tp2">🚗 Car (Diesel)</label></div>
                                        <div class="form-check"><input class="form-check-input" type="checkbox" value="car_electric" id="tp3"><label class="form-check-label" for="tp3">⚡ Car (Electric)</label></div>
                                        <div class="form-check"><input class="form-check-input" type="checkbox" value="bus" id="tp4" checked><label class="form-check-label" for="tp4">🚌 Bus</label></div>
                                        <div class="form-check"><input class="form-check-input" type="checkbox" value="train" id="tp5" checked><label class="form-check-label" for="tp5">🚂 Train</label></div>
                                        <div class="form-check"><input class="form-check-input" type="checkbox" value="plane" id="tp6" checked><label class="form-check-label" for="tp6">✈️ Plane</label></div>
                                        <div class="form-check"><input class="form-check-input" type="checkbox" value="motorcycle" id="tp7"><label class="form-check-label" for="tp7">🏍️ Motorcycle</label></div>
                                        <div class="form-check"><input class="form-check-input" type="checkbox" value="ebike" id="tp8"><label class="form-check-label" for="tp8">🚲 E-Bike</label></div>
                                        <div class="form-check"><input class="form-check-input" type="checkbox" value="escooter" id="tp9"><label class="form-check-label" for="tp9">🛴 E-Scooter</label></div>
                                    </div>

                                    <div class="d-grid">
                                        <button type="submit" id="calculate_advanced" class="btn btn-lg btn-custom">🔍 Analyze Journey</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-8">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h3 class="card-title">📊 Smart Results</h3>
                                <div id="results-placeholder" class="d-none">
                                    <canvas id="smart_emission_plot"></canvas>
                                    <div class="savings-highlight mt-4">
                                        <h4>💡 Smart Recommendations</h4>
                                        <div id="smart_recommendations"></div>
                                    </div>
                                </div>
                                <div id="welcome-message" class="card-gradient info-card p-4 text-center">
                                    <h4>👋 Welcome!</h4>
                                    <p class="mb-0">Enter your journey details and click 'Analyze Journey' to get started and receive personalized recommendations for eco-friendly travel!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="details-row" class="row mt-4 d-none">
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-body">
                                <h4 class="card-title">🌍 Environmental Impact</h4>
                                <table class="table table-striped">
                                    <thead>
                                        <tr><th>Transport</th><th>CO2 (kg)</th><th>NOx (g)</th><th>PM (g)</th></tr>
                                    </thead>
                                    <tbody id="environmental_table"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm h-100">
                            <div class="card-body">
                                <h4 class="card-title">💰 Cost Analysis</h4>
                                <table class="table table-striped">
                                    <thead>
                                        <tr><th>Transport</th><th>Total Cost (€)</th><th>Cost/km (€)</th><th>Cost/person (€)</th></tr>
                                    </thead>
                                    <tbody id="cost_table"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h4 class="card-title">🗺️ Interactive Route Map</h4>
                                <div id="advanced_map"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                         <div class="card shadow-sm">
                            <div class="card-body">
                                <h4 class="card-title">📊 Journey Summary</h4>
                                <div class="metric-box">
                                    <div class="metric-value" id="distance_display">- km</div>
                                    <h5>Total Distance</h5>
                                    <p class="mb-0 text-muted">Direct line between locations</p>
                                </div>
                                <div class="mt-3 p-3 bg-light rounded">
                                    <h5>🌍 Location Details</h5>
                                    <div id="location_details">
                                        <p>Location details will appear here after analysis.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Tab -->
            <div class="tab-pane fade" id="dashboard" role="tabpanel">
                <div class="row">
                    <div class="col-md-3 mb-3"><div class="metric-box"><div class="metric-value">2.1t</div><h5>Annual CO2</h5><p class="text-muted mb-0">🌱 25% below EU average</p></div></div>
                    <div class="col-md-3 mb-3"><div class="metric-box"><div class="metric-value">47</div><h5>Trips This Year</h5><p class="text-muted mb-0">📈 12% increase</p></div></div>
                    <div class="col-md-3 mb-3"><div class="metric-box"><div class="metric-value">380kg</div><h5>CO2 Saved</h5><p class="text-muted mb-0">🏆 Equivalent to 19 trees</p></div></div>
                    <div class="col-md-3 mb-3"><div class="metric-box"><div class="metric-value">🥉</div><h5>Eco Level</h5><p class="text-muted mb-0">Bronze - 500pts to Silver</p></div></div>
                </div>
                <div class="row mt-3">
                    <div class="col-lg-8 mb-4">
                        <div class="card shadow-sm"><div class="card-body"><h4 class="card-title">📈 Monthly Carbon Trends</h4><canvas id="carbon_trends"></canvas></div></div>
                    </div>
                    <div class="col-lg-4 mb-4">
                        <div class="card shadow-sm"><div class="card-body"><h4 class="card-title">🚊 Transport Mix</h4><canvas id="transport_donut"></canvas></div></div>
                    </div>
                </div>
                <div class="card card-gradient eco-card p-3">
                     <h4 class="card-title">🌍 Your Impact</h4>
                     <div class="row">
                         <div class="col-md-4"><h5>🎯 vs EU Average</h5><p>You: 2.1t CO2/year<br>EU Avg: 2.8t CO2/year<br>You're 25% better! 🌟</p></div>
                         <div class="col-md-4"><h5>🌱 Carbon Offset</h5><p>Trees equivalent: 105 trees<br>Solar panels: 0.8m² needed<br>Wind power: 1.2 MWh/year</p></div>
                         <div class="col-md-4"><h5>📊 This Month</h5><p>Trips: 8 journeys<br>Best choice: 🚂 Train (60%)<br>Savings: 45kg CO2 vs car</p></div>
                     </div>
                </div>
            </div>

            <!-- Carbon Offset Tab -->
            <div class="tab-pane fade" id="offset" role="tabpanel">
                <div class="row">
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h3>🌱 Offset Calculator</h3>
                                <p>Offset your travel emissions and support environmental projects!</p>
                                <div class="mb-3">
                                    <label for="offset_amount" class="form-label">CO2 to Offset (kg):</label>
                                    <input type="number" id="offset_amount" class="form-control" value="50" min="1" max="10000">
                                </div>
                                <div id="offset_project" class="mb-3">
                                    <label class="form-label">Choose Project:</label>
                                    <div class="form-check"><input type="radio" name="offset_project" class="form-check-input" value="forest" id="proj1" checked><label for="proj1">🌳 Forest Restoration (€15/ton)</label></div>
                                    <div class="form-check"><input type="radio" name="offset_project" class="form-check-input" value="wind" id="proj2"><label for="proj2">💨 Wind Energy (€12/ton)</label></div>
                                    <div class="form-check"><input type="radio" name="offset_project" class="form-check-input" value="solar" id="proj3"><label for="proj3">☀️ Solar Power (€18/ton)</label></div>
                                    <div class="form-check"><input type="radio" name="offset_project" class="form-check-input" value="ocean" id="proj4"><label for="proj4">🌊 Ocean Conservation (€25/ton)</label></div>
                                </div>
                                <div class="text-center bg-light p-3 rounded">
                                    <h3 style="color: #28a745;">Total Cost: €<span id="offset_cost">0.75</span></h3>
                                    <button id="purchase_offset" class="btn btn-custom">🛒 Calculate Impact</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h3>🎯 Project Impact</h3>
                                <div id="project-details">
                                    <!-- Dynamic Content Here -->
                                </div>
                                <h4 class="mt-3">Your Contribution:</h4>
                                <div id="offset_impact" class="p-3 bg-light rounded">
                                    <!-- Dynamic Content Here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="card shadow-sm">
                    <div class="card-body">
                        <h3 class="card-title">💡 Alternative Green Actions</h3>
                        <p>Can't offset right now? Here are other ways to reduce your carbon footprint:</p>
                        <div class="row">
                            <div class="col-md-3 mb-2"><div class="card card-gradient warning-card p-3 h-100"><h5>🏠 Home Energy</h5><p class="mb-0">Switch to LED bulbs<br>💾 Save: 50kg CO2/year</p></div></div>
                            <div class="col-md-3 mb-2"><div class="card card-gradient eco-card p-3 h-100"><h5>🥗 Diet Change</h5><p class="mb-0">Meat-free Mondays<br>💾 Save: 150kg CO2/year</p></div></div>
                            <div class="col-md-3 mb-2"><div class="card card-gradient info-card p-3 h-100"><h5>🚲 Cycling</h5><p class="mb-0">Bike to work 2x/week<br>💾 Save: 300kg CO2/year</p></div></div>
                            <div class="col-md-3 mb-2"><div class="card card-gradient danger-card p-3 h-100"><h5>✈️ Flight Reduction</h5><p class="mb-0">One less flight/year<br>💾 Save: 500kg CO2/year</p></div></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Eco Challenges Tab -->
            <div class="tab-pane fade" id="challenges" role="tabpanel">
                <div class="row">
                    <div class="col-lg-4 mb-4"><div class="card card-gradient eco-card p-3 h-100"><h3>🏆 Current Challenge</h3><h4>Green Week Challenge</h4><p>🎯 Goal: Use only public transport for 7 days<br>📅 Progress: 3/7 days completed</p><div class="progress" style="height: 20px;"><div class="progress-bar bg-light text-dark" role="progressbar" style="width: 43%;">43%</div></div><p class="mt-2 mb-0">🏆 Reward: 500 EcoPoints + Tree Badge</p></div></div>
                    <div class="col-lg-4 mb-4"><div class="card card-gradient info-card p-3 h-100"><h3>🌟 Achievements</h3><h5>🚲 Bike Warrior ✅</h5><p class="small">Unlocked: 2024-08-15</p><hr><h5>🌱 Carbon Neutral 🔄</h5><p class="small">Progress: 780/1000 kg</p><hr><h5>🚂 Train Master 🔒</h5><p class="small mb-0">Progress: 23/100</p></div></div>
                    <div class="col-lg-4 mb-4"><div class="card card-gradient warning-card p-3 h-100"><h3>📈 EcoPoints</h3><div class="carbon-score">2,450</div><p class="text-center mb-0">🥉 Bronze Level<br>500 points to Silver</p><hr><h5>Recent Points:</h5><p class="mb-0">✅ Train trip: +50 pts<br>🚲 Bike commute: +25 pts<br>🌱 Carbon offset: +100 pts</p></div></div>
                </div>
                <div class="card shadow-sm mt-3">
                    <div class="card-body">
                         <h3 class="card-title">🎯 Available Challenges</h3>
                         <div class="row">
                             <div class="col-md-4 mb-3">
                                <div class="border border-success rounded p-3 h-100 d-flex flex-column">
                                    <h4>🚲 Bike Week</h4>
                                    <p>Cycle for all short trips (< 5km) for one week.</p>
                                    <p class="mt-auto mb-2">🏆 Reward: 300 EcoPoints</p>
                                    <button class="btn btn-custom" onclick="alert('Bike Week Challenge started! Good luck!')">Start Challenge</button>
                                </div>
                             </div>
                             <div class="col-md-4 mb-3">
                                 <div class="border border-primary rounded p-3 h-100 d-flex flex-column">
                                    <h4>🚂 Train Explorer</h4>
                                    <p>Take 5 train journeys this month.</p>
                                    <p class="mt-auto mb-2">🏆 Reward: 200 EcoPoints + Badge</p>
                                    <button class="btn btn-custom" onclick="alert('Train Explorer Challenge started! All aboard!')">Start Challenge</button>
                                 </div>
                             </div>
                              <div class="col-md-4 mb-3">
                                 <div class="border border-warning rounded p-3 h-100 d-flex flex-column">
                                    <h4>🌱 Offset Hero</h4>
                                    <p>Offset 100kg of CO2 this month.</p>
                                    <p class="mt-auto mb-2">🏆 Reward: 500 EcoPoints + Tree Badge</p>
                                    <button class="btn btn-custom" onclick="alert('Offset Hero Challenge started! Save the planet!')">Start Challenge</button>
                                 </div>
                             </div>
                         </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Leaflet JS for Maps -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Chart.js for Plots -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Custom Application JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            
            // --- GLOBAL VARIABLES & CONFIGURATION ---
            let map;
            let emissionChart;
            const emissionFactors = {
                car_petrol: { name: '🚗 Car (Petrol)', co2: 0.192, cost_per_km: 0.12, nox: 0.025, pm: 0.003 },
                car_diesel: { name: '🚗 Car (Diesel)', co2: 0.171, cost_per_km: 0.10, nox: 0.045, pm: 0.008 },
                car_electric: { name: '⚡ Car (Electric)', co2: 0.053, cost_per_km: 0.08, nox: 0.001, pm: 0.001 },
                bus: { name: '🚌 Bus', co2: 0.105, cost_per_km: 0.05, nox: 0.015, pm: 0.004 },
                train: { name: '🚂 Train', co2: 0.041, cost_per_km: 0.07, nox: 0.002, pm: 0.001 },
                plane: { name: '✈️ Plane', co2: 0.255, cost_per_km: 0.15, nox: 0.035, pm: 0.002 },
                motorcycle: { name: '🏍️ Motorcycle', co2: 0.113, cost_per_km: 0.08, nox: 0.020, pm: 0.003 },
                ebike: { name: '🚲 E-Bike', co2: 0.022, cost_per_km: 0.02, nox: 0.001, pm: 0.000 },
                escooter: { name: '🛴 E-Scooter', co2: 0.031, cost_per_km: 0.03, nox: 0.001, pm: 0.000 }
            };

            const cityCoords = {
                "bratislava": { lat: 48.1486, lng: 17.1077, name: "Bratislava, Slovakia" },
                "prague": { lat: 50.0755, lng: 14.4378, name: "Prague, Czech Republic" },
                "vienna": { lat: 48.2082, lng: 16.3738, name: "Vienna, Austria" },
                "london": { lat: 51.5074, lng: -0.1278, name: "London, UK" },
                "paris": { lat: 48.8566, lng: 2.3522, name: "Paris, France" },
                "new york": { lat: 40.7128, lng: -74.0060, name: "New York, NY, USA" },
                "tokyo": { lat: 35.6762, lng: 139.6503, name: "Tokyo, Japan" },
            };

            // --- UI ELEMENT REFERENCES ---
            const journeyForm = document.getElementById('journeyForm');
            const passengersSlider = document.getElementById('passengers');
            const passengersLabel = document.getElementById('passengers-label');
            const calculateBtn = document.getElementById('calculate_advanced');
            
            const welcomeMessage = document.getElementById('welcome-message');
            const resultsPlaceholder = document.getElementById('results-placeholder');
            const detailsRow = document.getElementById('details-row');

            // --- INITIAL SETUP ---
            // Set default travel date to today
            document.getElementById('travel_date').valueAsDate = new Date();

            // Initialize map
            map = L.map('advanced_map').setView([51.505, -0.09], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // --- HELPER FUNCTIONS ---
            
            // Geocoding function with fallback
            async function geocodeAddress(address) {
                if (!address) return null;
                const addressLower = address.toLowerCase().trim();

                // Check hardcoded list first
                for (const city in cityCoords) {
                    if (addressLower.includes(city)) {
                        return cityCoords[city];
                    }
                }

                // Fallback to API
                try {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`, {
                        headers: { 'User-Agent': 'SmartCarbonApp/1.0' }
                    });
                    if (!response.ok) throw new Error('Network response was not ok.');
                    
                    const data = await response.json();
                    if (data && data.length > 0) {
                        return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon), name: data[0].display_name };
                    }
                } catch (error) {
                    console.error("Geocoding failed:", error);
                    return null;
                }
                return null;
            }

            // Haversine distance calculation
            function calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // Radius of the Earth in km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = 
                    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                    Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c; // Distance in km
            }
            
            function getCO2Color(kg) {
                if (kg < 10) return '#28a745';   // Green
                if (kg < 50) return '#ffc107';   // Yellow  
                if (kg < 100) return '#fd7e14';  // Orange
                return '#dc3545';                // Red
            }
            
            // --- MAIN CALCULATION LOGIC ---
            journeyForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                calculateBtn.disabled = true;
                calculateBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Analyzing...`;

                const from = document.getElementById('from').value;
                const to = document.getElementById('to').value;

                const [fromCoords, toCoords] = await Promise.all([geocodeAddress(from), geocodeAddress(to)]);

                if (!fromCoords) {
                    alert(`Could not find location: ${from}`);
                    resetButton();
                    return;
                }
                if (!toCoords) {
                    alert(`Could not find location: ${to}`);
                    resetButton();
                    return;
                }

                const passengers = parseInt(passengersSlider.value, 10);
                const isReturnTrip = document.getElementById('return_trip').checked;
                const selectedTransports = Array.from(document.querySelectorAll('#transport_types input:checked')).map(el => el.value);

                const distance = calculateDistance(fromCoords.lat, fromCoords.lng, toCoords.lat, toCoords.lng);
                const distanceAdj = isReturnTrip ? distance * 2 : distance;

                const results = [];
                for (const transport of selectedTransports) {
                    const factor = emissionFactors[transport];
                    if (factor) {
                        results.push({
                            transport: transport,
                            co2_kg: (distanceAdj * factor.co2) / passengers,
                            cost: distanceAdj * factor.cost_per_km,
                            nox_g: distanceAdj * factor.nox * 1000,
                            pm_g: distanceAdj * factor.pm * 1000,
                        });
                    }
                }
                
                // Sort results by CO2 emissions
                results.sort((a, b) => a.co2_kg - b.co2_kg);

                displayResults(results, { from, to, fromCoords, toCoords, distance, passengers, isReturnTrip });
                resetButton();
            });
            
            function resetButton() {
                 calculateBtn.disabled = false;
                 calculateBtn.innerHTML = '🔍 Analyze Journey';
            }

            // --- DISPLAY FUNCTIONS ---
            function displayResults(results, journeyDetails) {
                welcomeMessage.classList.add('d-none');
                resultsPlaceholder.classList.remove('d-none');
                detailsRow.classList.remove('d-none');
                
                // 1. Render Chart
                renderEmissionChart(results, journeyDetails);
                
                // 2. Render Tables
                renderTables(results, journeyDetails);
                
                // 3. Render Recommendations
                renderRecommendations(results, journeyDetails);

                // 4. Render Map and Summary
                renderMapAndSummary(journeyDetails);
            }
            
            function renderEmissionChart(results, journeyDetails) {
                 const ctx = document.getElementById('smart_emission_plot').getContext('2d');
                 if (emissionChart) {
                     emissionChart.destroy();
                 }
                 emissionChart = new Chart(ctx, {
                     type: 'bar',
                     data: {
                         labels: results.map(r => emissionFactors[r.transport].name),
                         datasets: [{
                             label: 'CO2 Emissions (kg)',
                             data: results.map(r => r.co2_kg.toFixed(2)),
                             backgroundColor: results.map(r => getCO2Color(r.co2_kg)),
                             borderColor: '#fff',
                             borderWidth: 2
                         }]
                     },
                     options: {
                         indexAxis: 'y',
                         responsive: true,
                         plugins: {
                             legend: { display: false },
                             title: { display: true, text: `🌍 Environmental Impact Comparison - ${journeyDetails.distance.toFixed(1)} km journey` }
                         },
                         scales: {
                            x: {
                                title: { display: true, text: 'CO2 Emissions (kg)' }
                            }
                         }
                     }
                 });
            }
            
            function renderTables(results, {distance, passengers, isReturnTrip}) {
                const envTable = document.getElementById('environmental_table');
                const costTable = document.getElementById('cost_table');
                envTable.innerHTML = '';
                costTable.innerHTML = '';

                const distanceAdj = isReturnTrip ? distance * 2 : distance;

                results.forEach(res => {
                    const factor = emissionFactors[res.transport];
                    envTable.innerHTML += `<tr><td>${factor.name}</td><td>${res.co2_kg.toFixed(2)}</td><td>${res.nox_g.toFixed(1)}</td><td>${res.pm_g.toFixed(2)}</td></tr>`;
                    costTable.innerHTML += `<tr><td>${factor.name}</td><td>${res.cost.toFixed(2)}</td><td>${(res.cost / distanceAdj).toFixed(3)}</td><td>${(res.cost / passengers).toFixed(2)}</td></tr>`;
                });
            }

            function renderRecommendations(results, journeyDetails) {
                if (results.length < 2) {
                    document.getElementById('smart_recommendations').innerHTML = "<p>Select at least two transport modes to get a comparison.</p>";
                    return;
                }
                const bestCO2 = results[0];
                const worstCO2 = results[results.length - 1];
                const bestCost = [...results].sort((a,b) => a.cost - b.cost)[0];
                
                const co2Savings = worstCO2.co2_kg - bestCO2.co2_kg;

                document.getElementById('smart_recommendations').innerHTML = `
                    <p>🌟 <strong>Eco Champion:</strong> ${emissionFactors[bestCO2.transport].name} is the greenest choice, saving up to <strong>${co2Savings.toFixed(1)} kg CO2</strong> compared to other options.</p>
                    <p>💰 <strong>Budget Winner:</strong> ${emissionFactors[bestCost.transport].name} is the most affordable at only <strong>€${bestCost.cost.toFixed(2)}</strong>.</p>
                    <p>🏆 <strong>Pro Tip:</strong> For many journeys, the train offers a great balance of cost, speed, and low environmental impact.</p>
                `;
            }

            function renderMapAndSummary(journeyDetails) {
                 document.getElementById('distance_display').textContent = `${journeyDetails.distance.toFixed(1)} km`;
                 document.getElementById('location_details').innerHTML = `
                    <p><strong>📍 From:</strong><br><small>${journeyDetails.fromCoords.name}</small></p>
                    <p><strong>🎯 To:</strong><br><small>${journeyDetails.toCoords.name}</small></p>
                    <p><strong>👥 Passengers:</strong> ${journeyDetails.passengers}</p>
                 `;
                
                // Clear previous map layers
                map.eachLayer(layer => {
                    if (layer instanceof L.Marker || layer instanceof L.Polyline) {
                        map.removeLayer(layer);
                    }
                });

                const bounds = L.latLngBounds([journeyDetails.fromCoords.lat, journeyDetails.fromCoords.lng], [journeyDetails.toCoords.lat, journeyDetails.toCoords.lng]);
                map.fitBounds(bounds.pad(0.1));

                L.marker([journeyDetails.fromCoords.lat, journeyDetails.fromCoords.lng]).addTo(map).bindPopup(`<b>From:</b> ${journeyDetails.from}`);
                L.marker([journeyDetails.toCoords.lat, journeyDetails.toCoords.lng]).addTo(map).bindPopup(`<b>To:</b> ${journeyDetails.to}`);
                
                L.polyline([
                    [journeyDetails.fromCoords.lat, journeyDetails.fromCoords.lng],
                    [journeyDetails.toCoords.lat, journeyDetails.toCoords.lng]
                ], {color: '#007bff', weight: 4}).addTo(map);
            }
            
            // --- EVENT LISTENERS for UI interactions ---
            passengersSlider.addEventListener('input', function() {
                passengersLabel.textContent = this.value;
            });
            
            // --- Dashboard Charts (Sample Data) ---
            new Chart(document.getElementById('carbon_trends').getContext('2d'), {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug'],
                    datasets: [
                        { label: 'Your CO2', data: [180, 220, 190, 160, 140, 200, 250, 180], borderColor: '#007bff', tension: 0.1, fill: false },
                        { label: 'EU Average', data: Array(8).fill(230), borderColor: '#dc3545', borderDash: [5, 5], fill: false },
                        { label: 'Paris Target', data: Array(8).fill(190), borderColor: '#28a745', borderDash: [2, 2], fill: false }
                    ]
                }
            });

            new Chart(document.getElementById('transport_donut').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['🚗 Car', '🚂 Train', '🚌 Bus', '🚲 Bike', '✈️ Plane'],
                    datasets: [{
                        data: [40, 25, 15, 15, 5],
                        backgroundColor: ['#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7']
                    }]
                }
            });

            // --- Carbon Offset Calculator Logic ---
            const offsetAmountInput = document.getElementById('offset_amount');
            const offsetProjectRadios = document.querySelectorAll('input[name="offset_project"]');
            
            const projectDetails = {
                forest: { cost: 15, html: `<h4>🌳 Forest Restoration</h4><p>📍 Location: Amazon Rainforest, Brazil<br>🎯 Impact: Plants 50 trees per ton CO2</p>` },
                wind:   { cost: 12, html: `<h4>💨 Wind Energy</h4><p>📍 Location: North Sea Wind Farm<br>🎯 Impact: Clean energy generation</p>` },
                solar:  { cost: 18, html: `<h4>☀️ Solar Power</h4><p>📍 Location: Sahara Solar Project<br>🎯 Impact: Renewable electricity</p>` },
                ocean:  { cost: 25, html: `<h4>🌊 Ocean Conservation</h4><p>📍 Location: Great Barrier Reef<br>🎯 Impact: Marine ecosystem protection</p>` }
            };

            function updateOffsetCalculator() {
                const amountKg = parseFloat(offsetAmountInput.value) || 0;
                const selectedProject = document.querySelector('input[name="offset_project"]:checked').value;
                const project = projectDetails[selectedProject];
                
                const totalCost = (amountKg / 1000) * project.cost;
                document.getElementById('offset_cost').textContent = totalCost.toFixed(2);
                document.getElementById('project-details').innerHTML = `<div class="card-gradient info-card p-3">${project.html}</div>`;

                let impactText = '';
                if (selectedProject === 'forest') {
                    const trees = (amountKg / 1000) * 50;
                    impactText = `🌳 <strong>Trees Planted:</strong> ${trees.toFixed(0)} trees`;
                } else {
                    impactText = `⚡️ Your contribution supports <strong>${(amountKg * 0.1).toFixed(1)} kWh</strong> of clean energy production.`;
                }
                document.getElementById('offset_impact').innerHTML = impactText;
            }

            offsetAmountInput.addEventListener('input', updateOffsetCalculator);
            offsetProjectRadios.forEach(radio => radio.addEventListener('change', updateOffsetCalculator));
            document.getElementById('purchase_offset').addEventListener('click', () => {
                const cost = document.getElementById('offset_cost').textContent;
                const amount = offsetAmountInput.value;
                alert(`Great choice! Your ${amount}kg CO2 offset would cost €${cost}. (This is a demo).`);
            });
            
            // Initialize offset calculator on load
            updateOffsetCalculator();
        });
    </script>
</body>
</html>